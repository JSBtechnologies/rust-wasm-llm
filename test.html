<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rust WASM LLM - Test Page</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.6;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            border-color: #ffeeba;
            color: #856404;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.2s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        #output {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h3 {
            margin-top: 0;
            color: #495057;
        }
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <h1>ü¶Ä Rust WASM LLM - Test Page</h1>

    <div id="wasm-status" class="status info">
        <strong>WASM Status:</strong> Initializing...
    </div>

    <div class="section">
        <h3>About This Project</h3>
        <p>
            This is a <strong>Rust-based WebAssembly LLM</strong> with RAG (Retrieval-Augmented Generation) support.
        </p>
        <p><strong>Current Status:</strong></p>
        <ul>
            <li>‚úÖ Compiles to WASM successfully</li>
            <li>‚úÖ getrandom 0.3 fix applied</li>
            <li>‚úÖ Ready for RAG implementation</li>
            <li>‚è≥ Inference awaiting Candle WebGPU support</li>
        </ul>
        <p>
            <strong>Note:</strong> Model inference is not yet available because Candle 0.9.1 lacks WebGPU support.
            Once Candle implements <code>Device::new_webgpu()</code>, this project will support browser-based inference.
        </p>
    </div>

    <div class="section">
        <h3>Test Controls</h3>
        <button id="test-init-btn">Test WASM Initialization</button>
        <button id="test-basic-btn" disabled>Test Basic Functions</button>
        <button id="clear-btn">Clear Output</button>
    </div>

    <div class="section">
        <h3>Test Output</h3>
        <div id="output">Waiting for tests to run...</div>
    </div>

    <div class="section">
        <h3>What Can Be Tested?</h3>
        <p>
            Since inference is not yet available, the following components can be tested:
        </p>
        <ul>
            <li><strong>WASM Loading:</strong> Verify the module loads correctly</li>
            <li><strong>Memory Management:</strong> Test Rust/JS memory interop</li>
            <li><strong>Error Handling:</strong> Verify error propagation</li>
            <li><strong>Future RAG:</strong> Vector DB, document storage (when implemented)</li>
        </ul>
    </div>

    <script type="module">
        let wasmModule = null;

        // Test WASM initialization
        document.getElementById('test-init-btn').addEventListener('click', async () => {
            const button = event.target;
            const statusDiv = document.getElementById('wasm-status');
            const output = document.getElementById('output');

            button.disabled = true;
            statusDiv.className = 'status info';
            statusDiv.innerHTML = '<div class="loader"></div><strong>Loading WASM module...</strong>';
            output.textContent = 'ü¶Ä Initializing Rust WASM...\n\n';

            try {
                // Import WASM module
                output.textContent += 'Importing module from ./pkg/rust_wasm_llm.js...\n';
                const wasm = await import('./pkg/rust_wasm_llm.js');

                output.textContent += 'Initializing WASM...\n';
                await wasm.default();

                wasmModule = wasm;

                statusDiv.className = 'status success';
                statusDiv.innerHTML = '<strong>‚úÖ WASM Loaded Successfully!</strong>';

                output.textContent += '\n‚úÖ WASM module initialized!\n';
                output.textContent += '\nAvailable exports:\n';
                output.textContent += Object.keys(wasm)
                    .filter(key => typeof wasm[key] === 'function' && key !== 'default')
                    .map(key => `  - ${key}()`)
                    .join('\n');

                output.textContent += '\n\nüéâ Rust WASM is ready for development!\n';
                output.textContent += '\nNext steps:\n';
                output.textContent += '  1. Implement RAG features (vector search, document storage)\n';
                output.textContent += '  2. Wait for Candle WebGPU support\n';
                output.textContent += '  3. Add model loading and inference\n';

                document.getElementById('test-basic-btn').disabled = false;

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `<strong>‚ùå WASM Loading Failed</strong>`;

                output.textContent += `\n‚ùå Error: ${error.message}\n\n`;
                output.textContent += 'Troubleshooting:\n';
                output.textContent += '  1. Make sure you ran: ./build-wasm.sh\n';
                output.textContent += '  2. Check that pkg/ directory exists\n';
                output.textContent += '  3. Serve this page via HTTP (not file://)\n';
                output.textContent += '     Example: python3 -m http.server 8000\n';
                output.textContent += '  4. Check browser console for details\n\n';
                output.textContent += `Full error:\n${error.stack}`;

                button.disabled = false;
            }
        });

        // Test basic functions
        document.getElementById('test-basic-btn').addEventListener('click', async () => {
            const output = document.getElementById('output');
            output.textContent = 'üß™ Testing WASM Functions...\n\n';

            try {
                if (!wasmModule) {
                    throw new Error('WASM module not loaded. Click "Test WASM Initialization" first.');
                }

                output.textContent += 'Testing available functions:\n\n';

                // Check what functions are exported
                const functions = Object.keys(wasmModule).filter(
                    key => typeof wasmModule[key] === 'function' && key !== 'default'
                );

                if (functions.length === 0) {
                    output.textContent += '‚ö†Ô∏è  No exported functions found.\n';
                    output.textContent += '\nThis is expected for a new project.\n';
                    output.textContent += 'Functions will be available after implementing RAG features.\n';
                } else {
                    output.textContent += `Found ${functions.length} exported function(s):\n`;
                    functions.forEach(fn => {
                        output.textContent += `  - ${fn}()\n`;
                    });

                    // Try calling test functions if they exist
                    if (wasmModule.test_wasm) {
                        output.textContent += '\nCalling test_wasm()...\n';
                        const result = wasmModule.test_wasm();
                        output.textContent += `Result: ${result}\n`;
                    }
                }

                output.textContent += '\n‚úÖ Function tests complete!\n';

            } catch (error) {
                output.textContent += `\n‚ùå Error: ${error.message}\n`;
                console.error(error);
            }
        });

        // Clear output
        document.getElementById('clear-btn').addEventListener('click', () => {
            document.getElementById('output').textContent = 'Output cleared. Ready for new tests.';
        });

        // Auto-run initialization on page load
        window.addEventListener('load', () => {
            const statusDiv = document.getElementById('wasm-status');
            statusDiv.className = 'status warning';
            statusDiv.innerHTML = '<strong>‚ö†Ô∏è  Ready to Test</strong><br>Click "Test WASM Initialization" to load the module.';
        });
    </script>

    <div class="section" style="margin-top: 30px; background: #f8f9fa;">
        <h3>Development Info</h3>
        <p><strong>Build Command:</strong> <code>./build-wasm.sh</code></p>
        <p><strong>Output Directory:</strong> <code>pkg/</code></p>
        <p><strong>Serve Command:</strong> <code>python3 -m http.server 8000</code></p>
        <p><strong>GitHub:</strong> <a href="https://github.com/yourusername/rust-wasm-llm">rust-wasm-llm</a></p>
        <p><strong>License:</strong> MIT OR Apache-2.0</p>
    </div>
</body>
</html>
